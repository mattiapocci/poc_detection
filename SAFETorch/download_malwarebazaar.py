import os
import sys
import requests
from tqdm import tqdm
os.chdir('SAFETorch/Malwarebazaar')
#os.chdir('/root/poc_detection/datasets/MALWAREbazaar')
query_url = 'https://bazaar.abuse.ch/browse.php?search=file_type%3Aexe'
pre_download_url = 'https://bazaar.abuse.ch'

api = 'https://mb-api.abuse.ch/api/v1/'
post_payload = {"query":"get_file_type","file_type":"exe","limit":"1000"}
samples = requests.post(api,post_payload).json()['data']
for sample in tqdm(samples):
    # possible keys of sample: sha256_hash, sha3_384_hash, sha1_hash, md5_hash, first_seen, last_seen, file_name, file_size
    # file_type_mime, file_type, reporter, anonymous, signature, imphash, tlsh, telfhash, ssdeep, dhash_icon, tags, intelligence
    post_payload = {"query":"get_file","sha256_hash":sample['sha256_hash']}
    dwnld = requests.post(api,post_payload)
    open(sample['sha256_hash'] + '.zip', 'wb').write(dwnld.content)
sys.exit()